{% extends 'base.html' %}
{% import 'teachers/_macros.html' as macros %}

{% block title %}Configuration — Chronos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">Configuration</h1>
</div>
<form method="post" class="vstack gap-4">
  <input type="hidden" name="form" value="closing-periods">
  <div class="card">
    <div class="card-header">
      <h2 class="h5 mb-0">Périodes de fermeture</h2>
    </div>
    <div class="card-body vstack gap-3">
      <p class="text-muted mb-0">
        Définissez les périodes pendant lesquelles l'établissement est fermé. Ces dates seront prises en compte lors de la
        planification et empêcheront la création de séances.
      </p>
      {{ macros.unavailability_ranges_widget(
        'closing_periods',
        closing_periods,
        "Périodes de fermeture",
        "Ajoutez une ou plusieurs plages pour indiquer les jours où aucune séance ne peut être programmée."
      ) }}
      {% if closing_period_records %}
      <div>
        <h3 class="h6">Périodes enregistrées</h3>
        <ul class="mb-0">
          {% for period in closing_period_records %}
          <li>
            {% if period.start_date == period.end_date %}
              Fermeture le {{ period.start_date.strftime('%d/%m/%Y') }}
            {% else %}
              Fermeture du {{ period.start_date.strftime('%d/%m/%Y') }} au {{ period.end_date.strftime('%d/%m/%Y') }}
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <p class="text-muted mb-0">Aucune période de fermeture n'est définie pour le moment.</p>
      {% endif %}
    </div>
    <div class="card-footer text-end">
      <button type="submit" class="btn btn-primary">Enregistrer</button>
    </div>
  </div>
</form>

<div class="row row-cols-1 row-cols-lg-3 g-4">
  <div class="col">
    <div class="card h-100" id="config-course-names">
      <div class="card-header">
        <h2 class="h5 mb-0">Noms de cours</h2>
      </div>
      <div class="card-body">
        <form method="post" class="vstack gap-2">
          <input type="hidden" name="form" value="course-name-create">
          <label class="form-label" for="new-course-name">Nouveau nom</label>
          <input type="text" class="form-control" name="name" id="new-course-name" placeholder="Ex. Mathématiques A" required>
          <div class="text-end">
            <button type="submit" class="btn btn-outline-primary btn-sm">Ajouter</button>
          </div>
        </form>
        <hr>
        <h3 class="h6">Noms disponibles</h3>
        <div class="list-group list-group-flush">
          {% for name in course_names %}
          <form method="post" class="list-group-item vstack gap-2">
            <input type="hidden" name="form" value="course-name-preferences">
            <input type="hidden" name="course_name_id" value="{{ name.id }}">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>
                <div class="fw-semibold">{{ name.name }}</div>
                <div class="text-muted small">{{ name.usage_count }} sous-groupe{% if name.usage_count > 1 %}s{% endif %}</div>
              </div>
              <button type="submit" class="btn btn-outline-primary btn-sm">Enregistrer</button>
            </div>
            <div>
              <label class="form-label small mb-1" for="preferred-rooms-{{ name.id }}">Salles à privilégier</label>
              <select
                id="preferred-rooms-{{ name.id }}"
                class="form-select form-select-sm"
                name="preferred_rooms"
                multiple
                size="5"
              >
                {% for room in rooms %}
                <option value="{{ room.id }}" {% if room in name.preferred_rooms %}selected{% endif %}>{{ room.name }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Les salles sélectionnées seront privilégiées lors de l'auto-génération.</div>
            </div>
          </form>
          {% else %}
          <div class="list-group-item">Ajoutez un premier nom pour commencer.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card h-100" id="config-equipments">
      <div class="card-header">
        <h2 class="h5 mb-0">Équipements</h2>
      </div>
      <div class="card-body">
        <form method="post" class="vstack gap-2">
          <input type="hidden" name="form" value="equipment-create">
          <label class="form-label" for="new-equipment-name">Nouvel équipement</label>
          <input type="text" class="form-control" name="name" id="new-equipment-name" required>
          <div class="text-end">
            <button type="submit" class="btn btn-outline-primary btn-sm">Ajouter</button>
          </div>
        </form>
        <hr>
        <h3 class="h6">Référentiel équipements</h3>
        <ul class="list-group list-group-flush">
          {% for equipment in equipments %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ equipment.name }}
            <span class="badge bg-light text-dark">{{ equipment.rooms|length }} salles • {{ equipment.courses|length }} cours</span>
          </li>
          {% else %}
          <li class="list-group-item">Aucun équipement pour le moment.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card h-100" id="config-softwares">
      <div class="card-header">
        <h2 class="h5 mb-0">Logiciels</h2>
      </div>
      <div class="card-body">
        <form method="post" class="vstack gap-2">
          <input type="hidden" name="form" value="software-create">
          <label class="form-label" for="new-software-name">Nouveau logiciel</label>
          <input type="text" class="form-control" name="name" id="new-software-name" required>
          <div class="text-end">
            <button type="submit" class="btn btn-outline-primary btn-sm">Ajouter</button>
          </div>
        </form>
        <hr>
        <h3 class="h6">Référentiel logiciels</h3>
        <ul class="list-group list-group-flush">
          {% for software in softwares %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ software.name }}
            <span class="badge bg-light text-dark">{{ software.rooms|length }} salles • {{ software.courses|length }} cours</span>
          </li>
          {% else %}
          <li class="list-group-item">Aucun logiciel pour le moment.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {% include 'teachers/_unavailability_script.html' %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof setupUnavailabilityWidgets === 'function') {
        setupUnavailabilityWidgets();
      }
    });
  </script>
{% endblock %}
