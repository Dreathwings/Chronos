{% extends 'base.html' %}
{% block title %}{{ course.name }} — Cours{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/courses.css') }}">
{% endblock %}

{% block content %}
<div class="row g-4 course-detail-layout">
  <div class="col-xl-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">Contraintes du cours</div>
      <div class="card-body">
        <form method="post" class="vstack gap-3">
          <input type="hidden" name="form" value="update">
          <div>
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" name="name" value="{{ course.name }}" required>
          </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3">{{ course.description }}</textarea>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Type de cours</label>
              <select class="form-select" name="course_type">
                <option value="CM" {% if course.course_type == 'CM' %}selected{% endif %}>Cours magistral</option>
                <option value="TD" {% if course.course_type == 'TD' %}selected{% endif %}>Travaux dirigés</option>
                <option value="TP" {% if course.course_type == 'TP' %}selected{% endif %}>Travaux pratiques</option>
                <option value="SAE" {% if course.course_type == 'SAE' %}selected{% endif %}>Situation d'apprentissage et d'évaluation</option>
              </select>
            </div>
            <div class="col">
              <label class="form-label">Durée séance (h)</label>
              <input type="number" class="form-control" name="session_length_hours" value="{{ course.session_length_hours }}" min="1">
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Séances requises</label>
              <input type="number" class="form-control" name="sessions_required" value="{{ course.sessions_required }}" min="1">
            </div>
            <div class="col">
              <label class="form-label">Priorité</label>
              <input type="number" class="form-control" name="priority" value="{{ course.priority }}" min="1">
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Début</label>
              <input type="date" class="form-control" name="start_date" value="{{ course.start_date }}">
            </div>
            <div class="col">
              <label class="form-label">Fin</label>
              <input type="date" class="form-control" name="end_date" value="{{ course.end_date }}">
            </div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="requires_computers" id="requires_computers" {% if course.requires_computers %}checked{% endif %}>
            <label class="form-check-label" for="requires_computers">Ordinateurs requis</label>
          </div>
          <div>
            <label class="form-label">Enseignants</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher un enseignant..."
              data-filter-target="#course-teachers-list"
            >
            <div id="course-teachers-list" class="vstack gap-1">
              {% for teacher in teachers %}
              <div class="form-check" data-filter-item data-filter-text="{{ teacher.name|lower|e }}">
                <input class="form-check-input" type="checkbox" name="teachers" value="{{ teacher.id }}" id="teacher-{{ teacher.id }}" {% if teacher in course.teachers %}checked{% endif %}>
                <label class="form-check-label" for="teacher-{{ teacher.id }}">{{ teacher.name }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
          <div>
            <label class="form-label">Classes associées</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher une classe..."
              data-filter-target="#course-classes-list"
            >
            <div id="course-classes-list" class="vstack">
              {% for class_group in class_groups %}
              {% set link = class_links_map.get(class_group.id) %}
              <div class="border rounded p-2 mb-2" data-filter-item data-filter-text="{{ class_group.name|lower|e }}">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="classes" value="{{ class_group.id }}" id="class-{{ class_group.id }}" {% if link %}checked{% endif %}>
                  <label class="form-check-label" for="class-{{ class_group.id }}">
                    {{ class_group.name }} — {{ class_group.size }} étudiants
                  </label>
                </div>
                <div class="mt-2 ms-4 text-muted small">
                  {% if course.course_type == 'TP' %}
                  Ce cours sera planifié en deux demi-groupes A et B.
                  {% elif course.course_type == 'SAE' %}
                  Deux enseignants peuvent être assignés simultanément pour cette classe.
                  {% elif course.course_type == 'CM' %}
                  Toutes les classes inscrites suivent le cours ensemble.
                  {% else %}
                  Ce cours est planifié pour la classe entière.
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% if course.class_links %}
          <div class="form-text">Les enseignants sont définis depuis la section dédiée ci-dessous.</div>
          {% endif %}
          <div>
            <label class="form-label">Équipements requis</label>
            {% for equipment in equipments %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="equipments" value="{{ equipment.id }}" id="equip-{{ equipment.id }}" {% if equipment in course.equipments %}checked{% endif %}>
              <label class="form-check-label" for="equip-{{ equipment.id }}">{{ equipment.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div>
            <label class="form-label">Logiciels requis</label>
            {% for software in softwares %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="softwares" value="{{ software.id }}" id="soft-{{ software.id }}" {% if software in course.softwares %}checked{% endif %}>
              <label class="form-check-label" for="soft-{{ software.id }}">{{ software.name }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
    </div>
  </div>
    {% if course.class_links %}
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-secondary text-white">Enseignants par classe</div>
      <div class="card-body">
        {% if teachers %}
        <form method="post" class="vstack gap-3">
          <input type="hidden" name="form" value="update-class-teachers">
          {% if course.course_type == 'CM' %}
          {% set class_names = course.class_links | map(attribute='class_group.name') | list %}
          {% set ns = namespace(shared_teacher=None) %}
          {% for link in course.class_links %}
          {% if ns.shared_teacher is none and (link.teacher_a or link.teacher_b) %}
          {% set ns.shared_teacher = link.teacher_a or link.teacher_b %}
          {% endif %}
          {% endfor %}
          <div class="border rounded p-2">
            <div class="fw-semibold">Cours magistral</div>
            <div class="text-muted small mb-2">
              Enseignant appliqué à l'ensemble des classes : {{ class_names | join(', ') }}.
            </div>
            <select class="form-select form-select-sm" name="course_teacher_all">
              <option value="" {% if not ns.shared_teacher %}selected{% endif %}>— Aucun enseignant —</option>
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}" {% if ns.shared_teacher and teacher.id == ns.shared_teacher.id %}selected{% endif %}>{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif course.course_type == 'SAE' %}
          {% for link in course.class_links %}
          <div class="border rounded p-2">
            <div class="fw-semibold">{{ link.class_group.name }}</div>
            <div class="text-muted small mb-2">Deux enseignants peuvent encadrer cette classe.</div>
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small mb-1">Enseignant 1</label>
                <select class="form-select form-select-sm" name="class_link_teacher_a_{{ link.class_group_id }}">
                  <option value="" {% if not link.teacher_a %}selected{% endif %}>— Aucun enseignant —</option>
                  {% for teacher in teachers %}
                  <option value="{{ teacher.id }}" {% if link.teacher_a and teacher.id == link.teacher_a.id %}selected{% endif %}>{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small mb-1">Enseignant 2</label>
                <select class="form-select form-select-sm" name="class_link_teacher_b_{{ link.class_group_id }}">
                  <option value="" {% if not link.teacher_b %}selected{% endif %}>— Aucun enseignant —</option>
                  {% for teacher in teachers %}
                  <option value="{{ teacher.id }}" {% if link.teacher_b and teacher.id == link.teacher_b.id %}selected{% endif %}>{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          {% for link in course.class_links %}
          {% set assigned_teacher = link.teacher_a or link.teacher_b %}
          <div class="border rounded p-2">
            <div class="fw-semibold">{{ link.class_group.name }}</div>
            <div class="text-muted small mb-2">
              {% if course.course_type == 'TP' %}
              Travaux pratiques — groupes A/B
              {% else %}
              Classe entière
              {% endif %}
            </div>
            <select class="form-select form-select-sm" name="class_link_teacher_{{ link.class_group_id }}">
              <option value="" {% if not assigned_teacher %}selected{% endif %}>— Aucun enseignant —</option>
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}" {% if assigned_teacher and teacher.id == assigned_teacher.id %}selected{% endif %}>{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% endfor %}
          {% endif %}
          <button type="submit" class="btn btn-outline-secondary">Mettre à jour</button>
        </form>
        {% else %}
        <p class="text-muted mb-0 small">Ajoutez des enseignants dans la liste ci-dessus pour les associer aux classes.</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
    <div class="d-grid gap-2 mt-4">
      <form method="post">
        <input type="hidden" name="form" value="auto-schedule">
        <button class="btn btn-success" type="submit">Générer automatiquement</button>
      </form>
      <form method="post">
        <input type="hidden" name="form" value="clear-sessions">
        <button class="btn btn-outline-danger" type="submit" {% if not course.sessions %}disabled{% endif %}>
          Supprimer toutes les séances planifiées
        </button>
      </form>
    </div>
  </div>
  <div class="col-xl-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-dark text-white">Journal de génération</div>
      <div class="card-body">
        {% if latest_generation_log %}
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ latest_generation_log.summary or 'Résultat enregistré' }}</div>
              <div class="text-muted small">
                {{ latest_generation_log.created_at.strftime('%d/%m/%Y %H:%M') }}
                {% if latest_generation_log.window_start and latest_generation_log.window_end %}
                — Période : {{ latest_generation_log.window_start }} → {{ latest_generation_log.window_end }}
                {% endif %}
              </div>
            </div>
            <span class="badge {{ status_badges.get(latest_generation_log.status, 'bg-secondary') }}">{{ status_labels.get(latest_generation_log.status, latest_generation_log.status|title) }}</span>
          </div>
          {% set messages = latest_generation_log.parsed_messages() %}
          {% if messages %}
          <ul class="list-unstyled small mb-0 mt-3">
            {% for entry in messages %}
            <li class="d-flex align-items-start gap-2 mb-1">
              <span class="badge {{ level_badges.get(entry.level, 'bg-secondary') }}">{{ latest_generation_log.level_label(entry.level) }}</span>
              <span>{{ entry.message }}</span>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        {% else %}
        <p class="text-muted mb-0 small">Aucune génération enregistrée pour ce cours.</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-info text-white">Ajouter une séance manuelle</div>
      <div class="card-body">
        {% if teachers and rooms and course.class_links %}
        <form method="post" class="row g-3">
          <input type="hidden" name="form" value="manual-session">
          <div class="col-md-4">
            <label class="form-label">Enseignant</label>
            <select class="form-select" name="teacher_id">
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Salle</label>
            <select class="form-select" name="room_id">
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Classe</label>
            <select class="form-select" name="class_group_choice">
              {% if course.is_cm %}
                {% set class_names = course.class_links | map(attribute='class_group.name') | join(', ') %}
                {% set cm_teacher = None %}
                {% for link in course.class_links %}
                  {% if cm_teacher is none and (link.teacher_a or link.teacher_b) %}
                    {% set cm_teacher = link.teacher_a or link.teacher_b %}
                  {% endif %}
                {% endfor %}
                {% if cm_teacher is none and course.teachers %}
                  {% set cm_teacher = course.teachers[0] %}
                {% endif %}
                <option value="ALL">
                  Toutes les classes
                  {% if class_names %}— {{ class_names }}{% endif %}
                  {% if cm_teacher %}( {{ cm_teacher.name }} ){% else %}( Aucun enseignant ){% endif %}
                </option>
              {% else %}
                {% for link in course.class_links %}
                  {% for subgroup_label in link.group_labels() %}
                  {% set value = link.class_group.id ~ ':' ~ (subgroup_label if subgroup_label else '') %}
                  {% set assigned_teacher = link.teacher_for_label(subgroup_label) %}
                  <option value="{{ value }}">
                    {{ link.class_group.name }} — {% if subgroup_label %}groupe {{ subgroup_label|upper }}{% else %}classe entière{% endif %}
                    {% if assigned_teacher %}( {{ assigned_teacher.name }} ){% else %}( Aucun enseignant ){% endif %}
                  </option>
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Heure de début</label>
            <select class="form-select" name="start_time">
              {% for start_time in start_times %}
              <option value="{{ start_time.strftime('%H:%M') }}">
                {{ start_time.strftime('%H:%M') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Durée (heures)</label>
            <input type="number" class="form-control" name="duration" value="{{ course.session_length_hours }}" min="1">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-info text-white">Ajouter</button>
          </div>
        </form>
        {% else %}
        <p class="text-muted mb-0">Ajoutez au moins un enseignant, une salle et associez une classe pour planifier manuellement une séance.</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-header bg-secondary text-white">Calendrier des séances</div>
      <div class="card-body">
        <div id="course-calendar"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  function chronosBindFilterInputs() {
    document.querySelectorAll('[data-filter-target]').forEach(function(input) {
      const targetSelector = input.getAttribute('data-filter-target');
      if (!targetSelector) {
        return;
      }
      const target = document.querySelector(targetSelector);
      if (!target) {
        return;
      }
      const updateVisibility = function() {
        const query = (input.value || '').trim().toLowerCase();
        const hasQuery = query.length > 0;
        const items = target.querySelectorAll('[data-filter-item]');
        items.forEach(function(item) {
          const filterText = (item.getAttribute('data-filter-text') || item.textContent || '').toLowerCase();
          const checkbox = item.querySelector('input[type="checkbox"]');
          const isSelected = checkbox ? checkbox.checked : false;
          const matchesQuery = hasQuery && filterText.indexOf(query) !== -1;
          if (isSelected || matchesQuery) {
            item.classList.remove('d-none');
          } else {
            item.classList.add('d-none');
          }
        });
      };
      input.addEventListener('input', updateVisibility);
      target.addEventListener('change', updateVisibility, true);
      updateVisibility();
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    chronosBindFilterInputs();
    const calendarEl = document.getElementById('course-calendar');
    const events = {{ events_json|safe }};
    const calendar = window.createChronosCalendar(calendarEl, events);
    calendar.render();
  });
</script>
{% endblock %}
