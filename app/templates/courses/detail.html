{% extends 'base.html' %}
{% block title %}{{ course.name }} — Cours{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/courses.css') }}">
{% endblock %}

{% block content %}
<div class="row g-4 course-detail-layout">
  <div class="col-xl-4">
    <div class="accordion" id="courseDetailsAccordion">
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingCourseConstraints">
          <button
            class="accordion-button bg-primary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseCourseConstraints"
            aria-expanded="true"
            aria-controls="collapseCourseConstraints"
          >
            Contraintes du cours
          </button>
        </h2>
        <div
          id="collapseCourseConstraints"
          class="accordion-collapse collapse show"
          aria-labelledby="headingCourseConstraints"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
            <form method="post" class="vstack gap-3">
              <input type="hidden" name="form" value="update">
              <div>
                <label class="form-label">Nom du cours</label>
                {% if course_names %}
                <select class="form-select" name="course_name_id">
                  <option value="">— Conserver le libellé actuel —</option>
                  {% for course_name in course_names %}
                  <option
                    value="{{ course_name.id }}"
                    {% if course.configured_name and course.configured_name.id == course_name.id %}selected{% endif %}
                  >{{ course_name.name }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">Sélectionnez un nom configuré pour appliquer une convention commune ou conservez le libellé actuel.</div>
                {% else %}
                <div class="alert alert-warning mb-2" role="alert">
                  Aucun nom de cours n'est encore configuré dans la page Configuration.
                </div>
                {% endif %}
                <div class="form-text">Libellé actuel : <strong>{{ course.name }}</strong></div>
              </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3">{{ course.description }}</textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Type de cours</label>
              <select class="form-select" name="course_type">
                <option value="CM" {% if course.course_type == 'CM' %}selected{% endif %}>CM</option>
                <option value="TD" {% if course.course_type == 'TD' %}selected{% endif %}>TD</option>
                <option value="TP" {% if course.course_type == 'TP' %}selected{% endif %}>TP</option>
                <option value="SAE" {% if course.course_type == 'SAE' %}selected{% endif %}>SAE</option>
                <option value="Eval" {% if course.course_type == 'Eval' %}selected{% endif %}>Eval</option>
              </select>
              <div class="form-text">Les cours sont générés selon l'ordre : CM → SAE → TD → TP → Éval.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Semestre</label>
              <select class="form-select" name="semester">
                {% for semester in semester_choices %}
                <option value="{{ semester }}" {% if course.semester == semester %}selected{% endif %}>{{ semester }}</option>
                {% endfor %}
              </select>
              <div class="form-text">La période est déterminée automatiquement selon le semestre.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Durée séance (h)</label>
              <input type="number" class="form-control" name="session_length_hours" value="{{ course.session_length_hours }}" min="1">
            </div>
          </div>
          <div class="border rounded p-3 bg-light" data-sae-split-option>
            <div class="d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center gap-2">
              <div>
                <div class="fw-semibold">Séances scindées pour les SAE</div>
                <div class="form-text">Choisissez si les heures fractionnées doivent être planifiées consécutivement.</div>
              </div>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="sae_split_consecutive"
                    id="edit-sae-split-consecutive"
                    value="1"
                    {% if course.sae_split_consecutive %}checked{% endif %}
                  >
                  <label class="form-check-label" for="edit-sae-split-consecutive">Séances consécutives</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="sae_split_consecutive"
                    id="edit-sae-split-flexible"
                    value="0"
                    {% if not course.sae_split_consecutive %}checked{% endif %}
                  >
                  <label class="form-check-label" for="edit-sae-split-flexible">Séances séparées dans la journée</label>
                </div>
              </div>
            </div>
            <div class="form-text mt-2">Applicable uniquement aux cours SAE. Les autres types restent inchangés.</div>
          </div>
          <div class="text-muted small">
            {% if course.semester_start and course.semester_end %}
            Période du semestre : {{ course.semester_start.strftime('%d/%m/%Y') }} → {{ course.semester_end.strftime('%d/%m/%Y') }}
            {% else %}
            Aucune période n'est définie pour ce semestre.
            {% endif %}
          </div>
          <div>
            <label class="form-label">Semaines autorisées pour la planification</label>
            {% if course_week_options %}
            <div class="course-week-grid border rounded">
              <div class="row row-cols-1 row-cols-sm-2 g-2">
                {% for option in course_week_options %}
                <div class="col">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="allowed_week_starts"
                      value="{{ option.value }}"
                      id="allowed-week-{{ option.value }}"
                      {% if option.value in selected_course_week_values %}checked{% endif %}
                    >
                    <label class="form-check-label" for="allowed-week-{{ option.value }}">{{ option.label }}</label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="form-text">Chaque semaine cochée donnera lieu à une séance automatique. Laissez vide pour autoriser l'ensemble du semestre.</div>
            {% else %}
            <div class="alert alert-info mb-0">Aucune semaine n'est disponible pour le semestre sélectionné.</div>
            {% endif %}
          </div>
          <div class="row g-2 align-items-center">
            <div class="col-sm-auto">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="requires_computers" id="requires_computers" {% if course.requires_computers %}checked{% endif %}>
                <label class="form-check-label" for="requires_computers">Ordinateurs requis</label>
              </div>
            </div>
            <div class="col">
              <label class="form-label mb-0" for="computers_required">Postes informatiques requis</label>
              <input
                type="number"
                class="form-control"
                name="computers_required"
                id="computers_required"
                min="0"
                value="{{ course.computers_required or 0 }}"
              >
              <div class="form-text">Indiquez 0 si le nombre exact de postes n'est pas contraignant.</div>
            </div>
          </div>
          <div>
            <label class="form-label">Enseignants</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher un enseignant..."
              data-filter-target="#course-teachers-list"
            >
              <div id="course-teachers-list" class="vstack gap-1">
                {% for teacher in teachers %}
                <div class="form-check" data-filter-item data-filter-text="{{ teacher.name|lower|e }}">
                  <input class="form-check-input" type="checkbox" name="teachers" value="{{ teacher.id }}" id="teacher-{{ teacher.id }}" {% if teacher in course.teachers %}checked{% endif %}>
                  <label class="form-check-label" for="teacher-{{ teacher.id }}">{{ teacher.name }}</label>
                </div>
                {% endfor %}
            </div>
          </div>
          <div>
            <label class="form-label">Classes associées</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher une classe..."
              data-filter-target="#course-classes-list"
            >
            <div id="course-classes-list" class="vstack">
              {% for class_group in class_groups %}
              {% set link = class_links_map.get(class_group.id) %}
              <div class="border rounded p-2 mb-2" data-filter-item data-filter-text="{{ class_group.name|lower|e }}">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="classes" value="{{ class_group.id }}" id="class-{{ class_group.id }}" {% if link %}checked{% endif %}>
                  <label class="form-check-label" for="class-{{ class_group.id }}">
                    {{ class_group.name }} — {{ class_group.size }} étudiants
                  </label>
                </div>
                <div class="mt-2 ms-4 text-muted small">
                  {% if course.course_type == 'TP' %}
                  Ce cours sera planifié en deux sous-groupes qui utilisent les noms définis dans la page Configuration.
                  {% elif course.course_type == 'SAE' %}
                  Deux enseignants doivent être assignés simultanément pour cette classe.
                  {% elif course.course_type == 'CM' %}
                  Toutes les classes inscrites suivent le cours ensemble.
                  {% else %}
                  Ce cours est planifié pour la classe entière.
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% if course.class_links %}
          <div class="form-text">Les enseignants sont définis depuis la section dédiée ci-dessous.</div>
          {% endif %}
          <div>
            <label class="form-label">Équipements requis</label>
            {% for equipment in equipments %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="equipments" value="{{ equipment.id }}" id="equip-{{ equipment.id }}" {% if equipment in course.equipments %}checked{% endif %}>
              <label class="form-check-label" for="equip-{{ equipment.id }}">{{ equipment.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div>
            <label class="form-label">Logiciels requis</label>
            {% for software in softwares %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="softwares" value="{{ software.id }}" id="soft-{{ software.id }}" {% if software in course.softwares %}checked{% endif %}>
              <label class="form-check-label" for="soft-{{ software.id }}">{{ software.name }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
          </div>
        </div>
      </div>
      {% if course.class_links %}
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingTeachersByClass">
          <button
            class="accordion-button collapsed bg-secondary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseTeachersByClass"
            aria-expanded="false"
            aria-controls="collapseTeachersByClass"
          >
            Enseignants par classe
          </button>
        </h2>
        <div
          id="collapseTeachersByClass"
          class="accordion-collapse collapse"
          aria-labelledby="headingTeachersByClass"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
        {% if available_teachers %}
        <form method="post" class="vstack gap-3">
          <input type="hidden" name="form" value="update-class-teachers">
          {% if course.course_type == 'CM' %}
          {% set class_names = course.class_links | map(attribute='class_group.name') | list %}
          {% set ns = namespace(shared_teacher=None) %}
          {% for link in course.class_links %}
          {% if ns.shared_teacher is none and (link.teacher_a or link.teacher_b) %}
          {% set ns.shared_teacher = link.teacher_a or link.teacher_b %}
          {% endif %}
          {% endfor %}
          <div class="border rounded p-2">
            <div class="fw-semibold">Cours magistral</div>
            <div class="text-muted small mb-2">
              Enseignant appliqué à l'ensemble des classes : {{ class_names | join(', ') }}.
            </div>
            <select class="form-select form-select-sm" name="course_teacher_all">
              <option value="" {% if not ns.shared_teacher %}selected{% endif %}>— Aucun enseignant —</option>
              {% for teacher in available_teachers %}
              <option value="{{ teacher.id }}" {% if ns.shared_teacher and teacher.id == ns.shared_teacher.id %}selected{% endif %}>{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif course.course_type == 'SAE' %}
          {% for link in course.class_links %}
          <div class="border rounded p-2">
            <div class="fw-semibold">{{ link.class_group.name }}</div>
            <div class="text-muted small mb-2">Deux enseignants doivent encadrer cette classe.</div>
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small mb-1">Enseignant 1</label>
                <select class="form-select form-select-sm" name="class_link_teacher_a_{{ link.class_group_id }}">
                  <option value="" {% if not link.teacher_a %}selected{% endif %}>— Aucun enseignant —</option>
                  {% for teacher in available_teachers %}
                  <option value="{{ teacher.id }}" {% if link.teacher_a and teacher.id == link.teacher_a.id %}selected{% endif %}>{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small mb-1">Enseignant 2</label>
                <select class="form-select form-select-sm" name="class_link_teacher_b_{{ link.class_group_id }}">
                  <option value="" {% if not link.teacher_b %}selected{% endif %}>— Aucun enseignant —</option>
                  {% for teacher in available_teachers %}
                  <option value="{{ teacher.id }}" {% if link.teacher_b and teacher.id == link.teacher_b.id %}selected{% endif %}>{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          {% for link in course.class_links %}
          {% set assigned_teacher = link.teacher_a or link.teacher_b %}
          <div class="border rounded p-2">
            <div class="fw-semibold">{{ link.class_group.name }}</div>
            <div class="text-muted small mb-2">
              {% if course.course_type == 'TP' %}
              Travaux pratiques — demi-groupes
              {% if teacher_duos_average_hours is not none and loop.first %}
              <div class="mt-1">
                <span class="text-muted small">
                  Moyenne des disponibilités communes proposées :
                  {{ ('%.1f' % teacher_duos_average_hours).rstrip('0').rstrip('.') }} h
                </span>
              </div>
              {% endif %}
              {% set recommended_duo = teacher_duos_by_class.get(link.class_group_id) %}
              {% if recommended_duo %}
              <div class="mt-1">
                <div>Duo recommandé :</div>
                <ul class="small mb-0 ps-3">
                  <li>
                    {{ recommended_duo[0].name }} + {{ recommended_duo[1].name }} —
                    {{ ('%.1f' % recommended_duo[2]).rstrip('0').rstrip('.') }} h communes
                  </li>
                </ul>
              </div>
              {% endif %}
              {% else %}
              Classe entière
              {% endif %}
            </div>
            {% if link.group_count == 2 %}
            {% set teacher_a = link.teacher_for_label('A') %}
            {% set teacher_b = link.teacher_for_label('B') %}
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small mb-1">Sous-groupe A — {{ link.subgroup_name_for('A') }}</label>
                <select class="form-select form-select-sm" name="class_link_teacher_{{ link.class_group_id }}_A">
                  <option value="" {% if not teacher_a %}selected{% endif %}>— Aucun enseignant —</option>
                  {% for teacher in available_teachers %}
                  <option value="{{ teacher.id }}" {% if teacher_a and teacher.id == teacher_a.id %}selected{% endif %}>{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small mb-1">Sous-groupe B — {{ link.subgroup_name_for('B') }}</label>
                <select class="form-select form-select-sm" name="class_link_teacher_{{ link.class_group_id }}_B">
                  <option value="" {% if not teacher_b %}selected{% endif %}>— Aucun enseignant —</option>
                  {% for teacher in available_teachers %}
                  <option value="{{ teacher.id }}" {% if teacher_b and teacher.id == teacher_b.id %}selected{% endif %}>{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            {% else %}
            {% set assigned_teacher = link.teacher_for_label(None) %}
            <select class="form-select form-select-sm" name="class_link_teacher_{{ link.class_group_id }}">
              <option value="" {% if not assigned_teacher %}selected{% endif %}>— Aucun enseignant —</option>
              {% for teacher in available_teachers %}
              <option value="{{ teacher.id }}" {% if assigned_teacher and teacher.id == assigned_teacher.id %}selected{% endif %}>{{ teacher.name }}</option>
              {% endfor %}
            </select>
            {% endif %}
          </div>
          {% endfor %}
          {% endif %}
          <button type="submit" class="btn btn-outline-secondary">Mettre à jour</button>
        </form>
        {% else %}
        <p class="text-muted mb-0 small">Ajoutez des enseignants dans la section Contraintes pour les associer aux classes.</p>
        {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingQuickActions">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseQuickActions"
            aria-expanded="false"
            aria-controls="collapseQuickActions"
          >
            Actions rapides
          </button>
        </h2>
        <div
          id="collapseQuickActions"
          class="accordion-collapse collapse"
          aria-labelledby="headingQuickActions"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
            <div class="d-grid gap-2">
              <form
                method="post"
                class="vstack gap-2"
                data-chronos-progress
                data-chronos-progress-async="true"
                data-chronos-progress-hours="{{ course_remaining_hours }}"
                data-chronos-progress-label="{{ course.name }} — {{ course_remaining_hours }} heure(s) restante(s)."
              >
                <input type="hidden" name="form" value="auto-schedule">
                <div class="small text-muted">
                  <div class="text-uppercase fw-semibold mb-1">Semaines de planification</div>
                  {% if selected_course_week_labels %}
                  <ul class="mb-2 ps-3">
                    {% for label in selected_course_week_labels %}
                    <li>{{ label }}</li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <div class="mb-2">Aucune semaine spécifique : toute la période du semestre sera utilisée.</div>
                  {% endif %}
                  <div>Modifiez cette sélection dans l'onglet « Contraintes du cours ».</div>
                </div>
                <button class="btn btn-success" type="submit">Générer automatiquement</button>
              </form>
              <form method="post">
                <input type="hidden" name="form" value="clear-sessions">
                <button class="btn btn-outline-danger" type="submit" {% if not course.sessions %}disabled{% endif %}>
                  Supprimer toutes les séances planifiées
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-8">
    <div class="accordion" id="courseSummaryAccordion">
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingCourseCalendar">
          <button
            class="accordion-button bg-secondary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseCourseCalendar"
            aria-expanded="true"
            aria-controls="collapseCourseCalendar"
          >
            Calendrier des séances
          </button>
        </h2>
        <div
          id="collapseCourseCalendar"
          class="accordion-collapse collapse show"
          aria-labelledby="headingCourseCalendar"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        <div id="course-calendar"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingGenerationLog">
          <button
            class="accordion-button collapsed bg-dark text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseGenerationLog"
            aria-expanded="false"
            aria-controls="collapseGenerationLog"
          >
            Journal de génération
          </button>
        </h2>
        <div
          id="collapseGenerationLog"
          class="accordion-collapse collapse"
          aria-labelledby="headingGenerationLog"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        {% if latest_generation_log %}
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ latest_generation_log.summary or 'Résultat enregistré' }}</div>
              <div class="text-muted small">
                {{ latest_generation_log.created_at.strftime('%d/%m/%Y %H:%M') }}
                {% if latest_generation_log.window_start and latest_generation_log.window_end %}
                — Période : {{ latest_generation_log.window_start }} → {{ latest_generation_log.window_end }}
                {% endif %}
              </div>
            </div>
            <span class="badge {{ status_badges.get(generation_display_status, 'bg-secondary') }}">{{ status_labels.get(generation_display_status, generation_display_status|title) }}</span>
          </div>
          {% set messages = latest_generation_log.parsed_messages() %}
          {% if messages %}
          <ul class="list-unstyled small mb-0 mt-3">
            {% for entry in messages %}
            <li class="d-flex align-items-start gap-2 mb-1">
              <span class="badge {{ level_badges.get(entry.level, 'bg-secondary') }}">{{ latest_generation_log.level_label(entry.level) }}</span>
              <span>{{ entry.message }}</span>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        {% else %}
        <p class="text-muted mb-0 small">Aucune génération enregistrée pour ce cours.</p>
        {% endif %}
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingManualSession">
          <button
            class="accordion-button collapsed bg-info text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseManualSession"
            aria-expanded="false"
            aria-controls="collapseManualSession"
          >
            Ajouter une séance manuelle
          </button>
        </h2>
        <div
          id="collapseManualSession"
          class="accordion-collapse collapse"
          aria-labelledby="headingManualSession"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        {% if teachers and rooms and course.class_links %}
        <form method="post" class="row g-3">
          <input type="hidden" name="form" value="manual-session">
          <div class="col-md-4">
            <label class="form-label">Enseignant</label>
            <select class="form-select" name="teacher_id">
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Salle</label>
            <select class="form-select" name="room_id">
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Classe</label>
            <select class="form-select" name="class_group_choice">
              {% if course.is_cm %}
                {% set class_names = course.class_links | map(attribute='class_group.name') | join(', ') %}
                {% set cm_teacher = None %}
                {% for link in course.class_links %}
                  {% if cm_teacher is none and (link.teacher_a or link.teacher_b) %}
                    {% set cm_teacher = link.teacher_a or link.teacher_b %}
                  {% endif %}
                {% endfor %}
                {% if cm_teacher is none and course.teachers %}
                  {% set cm_teacher = course.teachers[0] %}
                {% endif %}
                <option value="ALL">
                  Toutes les classes
                  {% if class_names %}— {{ class_names }}{% endif %}
                  {% if cm_teacher %}( {{ cm_teacher.name }} ){% else %}( Aucun enseignant ){% endif %}
                </option>
              {% else %}
                {% for link in course.class_links %}
                  {% for subgroup_label in link.group_labels() %}
                  {% set value = link.class_group.id ~ ':' ~ (subgroup_label if subgroup_label else '') %}
                  {% set assigned_teacher = link.teacher_for_label(subgroup_label) %}
                  {% set subgroup_display = link.subgroup_name_for(subgroup_label) %}
                  <option value="{{ value }}">
                    {{ link.class_group.name }} — {% if subgroup_label %}{{ subgroup_display }}{% else %}classe entière{% endif %}
                    {% if assigned_teacher %}( {{ assigned_teacher.name }} ){% else %}( Aucun enseignant ){% endif %}
                  </option>
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Heure de début</label>
            <select class="form-select" name="start_time">
              {% for start_time in start_times %}
              <option value="{{ start_time.strftime('%H:%M') }}">
                {{ start_time.strftime('%H:%M') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Durée (heures)</label>
            <input type="number" class="form-control" name="duration" value="{{ course.session_length_hours }}" min="1">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-info text-white">Ajouter</button>
          </div>
        </form>
        {% else %}
        <p class="text-muted mb-0">Ajoutez au moins un enseignant, une salle et associez une classe pour planifier manuellement une séance.</p>
        {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  function chronosBindFilterInputs() {
    document.querySelectorAll('[data-filter-target]').forEach(function(input) {
      const targetSelector = input.getAttribute('data-filter-target');
      if (!targetSelector) {
        return;
      }
      const target = document.querySelector(targetSelector);
      if (!target) {
        return;
      }
      const updateVisibility = function() {
        const query = (input.value || '').trim().toLowerCase();
        const hasQuery = query.length > 0;
        const items = target.querySelectorAll('[data-filter-item]');
        items.forEach(function(item) {
          const filterText = (item.getAttribute('data-filter-text') || item.textContent || '').toLowerCase();
          const checkbox = item.querySelector('input[type="checkbox"]');
          const isSelected = checkbox ? checkbox.checked : false;
          const matchesQuery = hasQuery && filterText.indexOf(query) !== -1;
          if (isSelected || matchesQuery) {
            item.classList.remove('d-none');
          } else {
            item.classList.add('d-none');
          }
        });
      };
      input.addEventListener('input', updateVisibility);
      target.addEventListener('change', updateVisibility, true);
      updateVisibility();
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    chronosBindFilterInputs();
    const calendarEl = document.getElementById('course-calendar');
    const events = {{ events_json|safe }};
    const saeToggleTargets = document.querySelectorAll('[data-sae-split-option]');
    const courseTypeSelect = document.querySelector('select[name="course_type"]');
    const updateSaeVisibility = function() {
      const isSae = courseTypeSelect && courseTypeSelect.value === 'SAE';
      saeToggleTargets.forEach(function(element) {
        if (isSae) {
          element.classList.remove('d-none');
        } else {
          element.classList.add('d-none');
        }
      });
    };
    if (courseTypeSelect) {
      courseTypeSelect.addEventListener('change', updateSaeVisibility);
    }
    updateSaeVisibility();
    const calendar = window.createChronosCalendar(calendarEl, events);
    calendar.render();
  });
</script>
{% endblock %}
