{% extends 'base.html' %}
{% block title %}{{ course.name }} — Cours{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/courses.css') }}">
{% endblock %}

{% block content %}
<div class="row g-4 course-detail-layout">
  <div class="col-xl-4">
    <div class="accordion" id="courseDetailsAccordion">
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingCourseConstraints">
          <button
            class="accordion-button bg-primary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseCourseConstraints"
            aria-expanded="true"
            aria-controls="collapseCourseConstraints"
          >
            Contraintes du cours
          </button>
        </h2>
        <div
          id="collapseCourseConstraints"
          class="accordion-collapse collapse show"
          aria-labelledby="headingCourseConstraints"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
            <form method="post" class="vstack gap-3">
              <input type="hidden" name="form" value="update">
              <div>
                <label class="form-label">Nom du cours</label>
                {% if course_names %}
                <select class="form-select" name="course_name_id">
                  <option value="">— Conserver le libellé actuel —</option>
                  {% for course_name in course_names %}
                  <option
                    value="{{ course_name.id }}"
                    {% if course.configured_name and course.configured_name.id == course_name.id %}selected{% endif %}
                  >{{ course_name.name }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">Sélectionnez un nom configuré pour appliquer une convention commune ou conservez le libellé actuel.</div>
                {% else %}
                <div class="alert alert-warning mb-2" role="alert">
                  Aucun nom de cours n'est encore configuré dans la page Configuration.
                </div>
                {% endif %}
                <div class="form-text">Libellé actuel : <strong>{{ course.name }}</strong></div>
              </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3">{{ course.description }}</textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">Type de cours</label>
              <select class="form-select" name="course_type">
                <option value="CM" {% if course.course_type == 'CM' %}selected{% endif %}>CM</option>
                <option value="TD" {% if course.course_type == 'TD' %}selected{% endif %}>TD</option>
                <option value="TP" {% if course.course_type == 'TP' %}selected{% endif %}>TP</option>
                <option value="SAE" {% if course.course_type == 'SAE' %}selected{% endif %}>SAE</option>
                <option value="Eval" {% if course.course_type == 'Eval' %}selected{% endif %}>Eval</option>
              </select>
              <div class="form-text">Les cours sont générés selon l'ordre : CM → SAE → TD → TP → Éval.</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Semestre</label>
              <select class="form-select" name="semester">
                {% for semester in semester_choices %}
                <option value="{{ semester }}" {% if course.semester == semester %}selected{% endif %}>{{ semester }}</option>
                {% endfor %}
              </select>
              <div class="form-text">La période est déterminée automatiquement selon le semestre.</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Durée séance (h)</label>
              <input type="number" class="form-control" name="session_length_hours" value="{{ course.session_length_hours }}" min="1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Semaines à générer</label>
              <input type="number" class="form-control" name="sessions_per_week" value="{{ course.sessions_per_week }}" min="1">
              <div class="form-text">Nombre total de semaines à planifier lorsque aucune semaine n'est sélectionnée.</div>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">Couleur</label>
              <input type="color" class="form-control form-control-color" name="color" value="{{ course.color or '#0d6efd' }}">
              <div class="form-text">Couleur affichée dans les calendriers.</div>
            </div>
          </div>
          <div class="text-muted small">
            {% if course.semester_start and course.semester_end %}
            Période du semestre : {{ course.semester_start.strftime('%d/%m/%Y') }} → {{ course.semester_end.strftime('%d/%m/%Y') }}
            {% else %}
            Aucune période n'est définie pour ce semestre.
            {% endif %}
          </div>
          <div>
            <label class="form-label">Semaines autorisées pour la planification</label>
            {% if course_week_options %}
            <div class="course-week-grid border rounded">
              <div class="row row-cols-1 row-cols-sm-2 g-2">
                {% for option in course_week_options %}
                <div class="col">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="allowed_week_starts"
                      value="{{ option.value }}"
                      id="allowed-week-{{ option.value }}"
                      {% if option.value in selected_course_week_values %}checked{% endif %}
                    >
                    <label class="form-check-label" for="allowed-week-{{ option.value }}">{{ option.label }}</label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="form-text">Chaque semaine cochée donnera lieu à une séance automatique. Laissez vide pour autoriser l'ensemble du semestre.</div>
            {% else %}
            <div class="alert alert-info mb-0">Aucune semaine n'est disponible pour le semestre sélectionné.</div>
            {% endif %}
          </div>
          <div class="row g-2 align-items-center">
            <div class="col-sm-auto">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="requires_computers" id="requires_computers" {% if course.requires_computers %}checked{% endif %}>
                <label class="form-check-label" for="requires_computers">Ordinateurs requis</label>
              </div>
            </div>
            <div class="col">
              <label class="form-label mb-0" for="computers_required">Postes informatiques requis</label>
              <input
                type="number"
                class="form-control"
                name="computers_required"
                id="computers_required"
                min="0"
                value="{{ course.computers_required or 0 }}"
              >
              <div class="form-text">Indiquez 0 si le nombre exact de postes n'est pas contraignant.</div>
            </div>
          </div>
          <div>
            <label class="form-label">Enseignants</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher un enseignant..."
              data-filter-target="#course-teachers-list"
            >
            <div id="course-teachers-list" class="vstack gap-2">
              {% for teacher in teachers %}
              {% set teacher_selected = teacher in course.teachers %}
              {% set hours_value = teacher_hours_map.get(teacher.id, course.session_length_hours) %}
              <div
                class="border rounded p-2"
                data-filter-item
                data-filter-text="{{ teacher.name|lower|e }}"
              >
                <div class="form-check d-flex align-items-center gap-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="teachers"
                    value="{{ teacher.id }}"
                    id="teacher-{{ teacher.id }}"
                    data-teacher-checkbox
                    {% if teacher_selected %}checked{% endif %}
                  >
                  <label class="form-check-label" for="teacher-{{ teacher.id }}">{{ teacher.name }}</label>
                </div>
                <div class="mt-2">
                  <label class="form-label small mb-1" for="teacher-hours-{{ teacher.id }}">Heures à générer</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    name="teacher_hours_{{ teacher.id }}"
                    id="teacher-hours-{{ teacher.id }}"
                    value="{{ hours_value }}"
                    min="0"
                    data-teacher-hours-for="{{ teacher.id }}"
                    data-default-hours="{{ hours_value }}"
                    {% if not teacher_selected %}disabled{% endif %}
                  >
                  <div class="form-text">Volume total d'heures assigné à cet enseignant pour la génération automatique.</div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div>
            <label class="form-label">Classes associées</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher une classe..."
              data-filter-target="#course-classes-list"
            >
            <div id="course-classes-list" class="vstack">
              {% for class_group in class_groups %}
              {% set link = class_links_map.get(class_group.id) %}
              <div class="border rounded p-2 mb-2" data-filter-item data-filter-text="{{ class_group.name|lower|e }}">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="classes" value="{{ class_group.id }}" id="class-{{ class_group.id }}" {% if link %}checked{% endif %}>
                  <label class="form-check-label" for="class-{{ class_group.id }}">
                    {{ class_group.name }} — {{ class_group.size }} étudiants
                  </label>
                </div>
                <div class="mt-2 ms-4 text-muted small">
                  {% if course.course_type == 'TP' %}
                  Ce cours sera planifié en deux sous-groupes qui utilisent les noms définis dans la page Configuration.
                  {% elif course.course_type == 'SAE' %}
                  Chaque classe est encadrée par un binôme d'enseignants sur des séances de 4 h.
                  {% elif course.course_type == 'CM' %}
                  Toutes les classes inscrites suivent le cours ensemble.
                  {% else %}
                  Ce cours est planifié pour la classe entière.
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div>
            <label class="form-label">Équipements requis</label>
            {% for equipment in equipments %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="equipments" value="{{ equipment.id }}" id="equip-{{ equipment.id }}" {% if equipment in course.equipments %}checked{% endif %}>
              <label class="form-check-label" for="equip-{{ equipment.id }}">{{ equipment.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div>
            <label class="form-label">Logiciels requis</label>
            {% for software in softwares %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="softwares" value="{{ software.id }}" id="soft-{{ software.id }}" {% if software in course.softwares %}checked{% endif %}>
              <label class="form-check-label" for="soft-{{ software.id }}">{{ software.name }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingQuickActions">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseQuickActions"
            aria-expanded="false"
            aria-controls="collapseQuickActions"
          >
            Actions rapides
          </button>
        </h2>
        <div
          id="collapseQuickActions"
          class="accordion-collapse collapse"
          aria-labelledby="headingQuickActions"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
            <div class="d-grid gap-2">
              <form
                method="post"
                class="vstack gap-2"
                data-chronos-progress
                data-chronos-progress-async="true"
                data-chronos-progress-hours="{{ course_remaining_hours }}"
                data-chronos-progress-label="{{ course.name }} — {{ course_remaining_hours }} heure(s) restante(s)."
              >
                <input type="hidden" name="form" value="auto-schedule">
                <div class="small text-muted">
                  <div class="text-uppercase fw-semibold mb-1">Semaines de planification</div>
                  {% if selected_course_week_labels %}
                  <ul class="mb-2 ps-3">
                    {% for label in selected_course_week_labels %}
                    <li>{{ label }}</li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <div class="mb-2">Aucune semaine spécifique : toute la période du semestre sera utilisée.</div>
                  {% endif %}
                  <div>Modifiez cette sélection dans l'onglet « Contraintes du cours ».</div>
                </div>
                <button class="btn btn-success" type="submit">Générer automatiquement</button>
              </form>
              <form method="post">
                <input type="hidden" name="form" value="clear-sessions">
                <button class="btn btn-outline-danger" type="submit" {% if not course.sessions %}disabled{% endif %}>
                  Supprimer toutes les séances planifiées
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-8">
    <div class="accordion" id="courseSummaryAccordion">
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingCourseCalendar">
          <button
            class="accordion-button bg-secondary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseCourseCalendar"
            aria-expanded="true"
            aria-controls="collapseCourseCalendar"
          >
            Calendrier des séances
          </button>
        </h2>
        <div
          id="collapseCourseCalendar"
          class="accordion-collapse collapse show"
          aria-labelledby="headingCourseCalendar"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        <div id="course-calendar"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingSessionManagement">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseSessionManagement"
            aria-expanded="false"
            aria-controls="collapseSessionManagement"
          >
            Gestion des séances
          </button>
        </h2>
        <div
          id="collapseSessionManagement"
          class="accordion-collapse collapse"
          aria-labelledby="headingSessionManagement"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
            {% if course_sessions %}
            <div class="vstack gap-3">
              {% for session in course_sessions %}
              <div class="border rounded p-3">
                <div class="d-flex flex-column flex-lg-row justify-content-between gap-2 mb-3">
                  <div>
                    <div class="fw-semibold">
                      {{ session.start_time.strftime('%d/%m/%Y') }} — {{ session.start_time.strftime('%H:%M') }} → {{ session.end_time.strftime('%H:%M') }}
                    </div>
                    <div class="text-muted small">
                      {{ session.room.name }} · {% if session.teacher %}{{ session.teacher.name }}{% else %}Aucun enseignant{% endif %}
                    </div>
                    <div class="text-muted small">{{ session.attendee_names() | join(', ') }}</div>
                  </div>
                  <div class="text-muted small">
                    Durée : {{ session.duration_hours }} h
                  </div>
                </div>
                <form method="post" class="row g-2 align-items-end">
                  <input type="hidden" name="form" value="update-session">
                  <input type="hidden" name="session_id" value="{{ session.id }}">
                  <div class="col-md-3">
                    <label class="form-label small">Date</label>
                    <input type="date" class="form-control form-control-sm" name="date" value="{{ session.start_time.strftime('%Y-%m-%d') }}" required>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small">Début</label>
                    <select class="form-select form-select-sm" name="start_time">
                      {% set session_start = session.start_time.strftime('%H:%M') %}
                      {% for start_time in start_times %}
                      {% set start_label = start_time.strftime('%H:%M') %}
                      <option value="{{ start_label }}" {% if start_label == session_start %}selected{% endif %}>{{ start_label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small">Enseignant</label>
                    <select class="form-select form-select-sm" name="teacher_id" {% if not available_teachers %}disabled{% endif %}>
                      {% for teacher in available_teachers %}
                      <option value="{{ teacher.id }}" {% if session.teacher and session.teacher.id == teacher.id %}selected{% endif %}>{{ teacher.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small">Salle</label>
                    <select class="form-select form-select-sm" name="room_id">
                      {% for room in rooms %}
                      <option value="{{ room.id }}" {% if session.room_id == room.id %}selected{% endif %}>{{ room.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-1 text-end">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Mettre à jour</button>
                  </div>
                </form>
                <form method="post" class="text-end mt-2">
                  <input type="hidden" name="form" value="delete-session">
                  <input type="hidden" name="session_id" value="{{ session.id }}">
                  <button type="submit" class="btn btn-outline-danger btn-sm">Supprimer</button>
                </form>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucune séance n'est planifiée pour le moment.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingGenerationLog">
          <button
            class="accordion-button collapsed bg-dark text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseGenerationLog"
            aria-expanded="false"
            aria-controls="collapseGenerationLog"
          >
            Journal de génération
          </button>
        </h2>
        <div
          id="collapseGenerationLog"
          class="accordion-collapse collapse"
          aria-labelledby="headingGenerationLog"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        {% if latest_generation_log %}
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ latest_generation_log.summary or 'Résultat enregistré' }}</div>
              <div class="text-muted small">
                {{ latest_generation_log.created_at.strftime('%d/%m/%Y %H:%M') }}
                {% if latest_generation_log.window_start and latest_generation_log.window_end %}
                — Période : {{ latest_generation_log.window_start }} → {{ latest_generation_log.window_end }}
                {% endif %}
              </div>
            </div>
            <span class="badge {{ status_badges.get(generation_display_status, 'bg-secondary') }}">{{ status_labels.get(generation_display_status, generation_display_status|title) }}</span>
          </div>
          {% set messages = latest_generation_log.parsed_messages() %}
          {% if messages %}
          <ul class="list-unstyled small mb-0 mt-3">
            {% for entry in messages %}
            <li class="d-flex flex-column gap-1 mb-2">
              <div class="d-flex align-items-start gap-2">
                <span class="badge {{ level_badges.get(entry.level, 'bg-secondary') }}">{{ latest_generation_log.level_label(entry.level) }}</span>
                <span>{{ entry.message }}</span>
              </div>
              {% if entry.suggestions %}
              <ul class="mb-0 small ps-5 text-muted">
                {% for suggestion in entry.suggestions %}
                <li>{{ suggestion }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        {% else %}
        <p class="text-muted mb-0 small">Aucune génération enregistrée pour ce cours.</p>
        {% endif %}
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingManualSession">
          <button
            class="accordion-button collapsed bg-info text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseManualSession"
            aria-expanded="false"
            aria-controls="collapseManualSession"
          >
            Ajouter une séance manuelle
          </button>
        </h2>
        <div
          id="collapseManualSession"
          class="accordion-collapse collapse"
          aria-labelledby="headingManualSession"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        {% if available_teachers and rooms and course.class_links %}
        <form method="post" class="row g-3">
          <input type="hidden" name="form" value="manual-session">
          <div class="col-md-4">
            <label class="form-label">Enseignant</label>
            <select class="form-select" name="teacher_id">
              {% for teacher in available_teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Salle</label>
            <select class="form-select" name="room_id">
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Classe</label>
            <select class="form-select" name="class_group_choice">
              {% if course.is_cm %}
                {% set class_names = course.class_links | map(attribute='class_group.name') | join(', ') %}
                <option value="ALL">
                  Toutes les classes
                  {% if class_names %}— {{ class_names }}{% endif %}
                </option>
              {% else %}
                {% for link in course.class_links %}
                  {% for subgroup_label in link.group_labels() %}
                  {% set value = link.class_group.id ~ ':' ~ (subgroup_label if subgroup_label else '') %}
                  {% set subgroup_display = link.subgroup_name_for(subgroup_label) %}
                  <option value="{{ value }}">
                    {{ link.class_group.name }} — {% if subgroup_label %}{{ subgroup_display }}{% else %}classe entière{% endif %}
                  </option>
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Heure de début</label>
            <select class="form-select" name="start_time">
              {% for start_time in start_times %}
              <option value="{{ start_time.strftime('%H:%M') }}">
                {{ start_time.strftime('%H:%M') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Durée (heures)</label>
            <input type="number" class="form-control" name="duration" value="{{ course.session_length_hours }}" min="1">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-info text-white">Ajouter</button>
          </div>
        </form>
        {% else %}
        <p class="text-muted mb-0">Ajoutez au moins un enseignant associé au cours, une salle et une classe pour planifier manuellement une séance.</p>
        {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  function chronosBindFilterInputs() {
    document.querySelectorAll('[data-filter-target]').forEach(function(input) {
      const targetSelector = input.getAttribute('data-filter-target');
      if (!targetSelector) {
        return;
      }
      const target = document.querySelector(targetSelector);
      if (!target) {
        return;
      }
      const updateVisibility = function() {
        const query = (input.value || '').trim().toLowerCase();
        const hasQuery = query.length > 0;
        const items = target.querySelectorAll('[data-filter-item]');
        items.forEach(function(item) {
          const filterText = (item.getAttribute('data-filter-text') || item.textContent || '').toLowerCase();
          const checkbox = item.querySelector('input[type="checkbox"]');
          const isSelected = checkbox ? checkbox.checked : false;
          const matchesQuery = hasQuery && filterText.indexOf(query) !== -1;
          if (isSelected || matchesQuery) {
            item.classList.remove('d-none');
          } else {
            item.classList.add('d-none');
          }
        });
      };
      input.addEventListener('input', updateVisibility);
      target.addEventListener('change', updateVisibility, true);
      updateVisibility();
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    chronosBindFilterInputs();
    document.querySelectorAll('[data-teacher-checkbox]').forEach(function(checkbox) {
      const teacherId = checkbox.value;
      const hoursInput = document.querySelector('[data-teacher-hours-for="' + teacherId + '"]');
      const defaultValue = hoursInput ? hoursInput.getAttribute('data-default-hours') : null;
      const updateHoursState = function() {
        if (!hoursInput) {
          return;
        }
        hoursInput.disabled = !checkbox.checked;
        if (!checkbox.checked && defaultValue !== null) {
          hoursInput.value = defaultValue;
        }
      };
      checkbox.addEventListener('change', updateHoursState);
      updateHoursState();
    });
    const calendarEl = document.getElementById('course-calendar');
    const events = {{ events_json|safe }};
    const calendar = window.createChronosCalendar(calendarEl, events);
    calendar.render();
  });
</script>
{% endblock %}
