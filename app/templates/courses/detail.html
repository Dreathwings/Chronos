{% extends 'base.html' %}
{% block title %}{{ course.name }} — Cours{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/courses.css') }}">
{% endblock %}

{% block content %}
<div class="row g-4 course-detail-layout">
  <div class="col-xl-4">
    <div class="accordion" id="courseDetailsAccordion">
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingCourseConstraints">
          <button
            class="accordion-button bg-primary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseCourseConstraints"
            aria-expanded="true"
            aria-controls="collapseCourseConstraints"
          >
            Contraintes du cours
          </button>
        </h2>
        <div
          id="collapseCourseConstraints"
          class="accordion-collapse collapse show"
          aria-labelledby="headingCourseConstraints"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
            <form method="post" class="vstack gap-3">
              <input type="hidden" name="form" value="update">
              <div>
                <label class="form-label">Nom du cours</label>
                {% if course_names %}
                <select class="form-select" name="course_name_id">
                  <option value="">— Conserver le libellé actuel —</option>
                  {% for course_name in course_names %}
                  <option
                    value="{{ course_name.id }}"
                    {% if course.configured_name and course.configured_name.id == course_name.id %}selected{% endif %}
                  >{{ course_name.name }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">Sélectionnez un nom configuré pour appliquer une convention commune ou conservez le libellé actuel.</div>
                {% else %}
                <div class="alert alert-warning mb-2" role="alert">
                  Aucun nom de cours n'est encore configuré dans la page Configuration.
                </div>
                {% endif %}
                <div class="form-text">Libellé actuel : <strong>{{ course.name }}</strong></div>
              </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3">{{ course.description }}</textarea>
          </div>
          <div>
            <label class="form-label">Couleur du cours</label>
            <input
              type="color"
              class="form-control form-control-color"
              name="color"
              value="{{ course.color or '#0d6efd' }}"
              title="Choisissez une couleur pour identifier ce cours"
            >
            <div class="form-text">La couleur choisie sera utilisée dans les calendriers.</div>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Type de cours</label>
              <select class="form-select" name="course_type">
                <option value="CM" {% if course.course_type == 'CM' %}selected{% endif %}>CM</option>
                <option value="TD" {% if course.course_type == 'TD' %}selected{% endif %}>TD</option>
                <option value="TP" {% if course.course_type == 'TP' %}selected{% endif %}>TP</option>
                <option value="SAE" {% if course.course_type == 'SAE' %}selected{% endif %}>SAE</option>
                <option value="Eval" {% if course.course_type == 'Eval' %}selected{% endif %}>Eval</option>
              </select>
              <div class="form-text">Les cours sont générés selon l'ordre : CM → SAE → TD → TP → Éval.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Semestre</label>
              <select class="form-select" name="semester">
                {% for semester in semester_choices %}
                <option value="{{ semester }}" {% if course.semester == semester %}selected{% endif %}>{{ semester }}</option>
                {% endfor %}
              </select>
              <div class="form-text">La période est déterminée automatiquement selon le semestre.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Durée séance (h)</label>
              <input type="number" class="form-control" name="session_length_hours" value="{{ course.session_length_hours }}" min="1">
            </div>
          </div>
          <div class="text-muted small">
            {% if course.semester_start and course.semester_end %}
            Période du semestre : {{ course.semester_start.strftime('%d/%m/%Y') }} → {{ course.semester_end.strftime('%d/%m/%Y') }}
            {% else %}
            Aucune période n'est définie pour ce semestre.
            {% endif %}
          </div>
          <div>
            <label class="form-label">Semaines autorisées pour la planification</label>
            {% if course_week_options %}
            <div class="course-week-grid border rounded">
              <div class="row row-cols-1 row-cols-sm-2 g-2">
                {% for option in course_week_options %}
                <div class="col">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="allowed_week_starts"
                      value="{{ option.value }}"
                      id="allowed-week-{{ option.value }}"
                      {% if option.value in selected_course_week_values %}checked{% endif %}
                    >
                    <label class="form-check-label" for="allowed-week-{{ option.value }}">{{ option.label }}</label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="form-text">Chaque semaine cochée donnera lieu à une séance automatique. Laissez vide pour autoriser l'ensemble du semestre.</div>
            {% else %}
            <div class="alert alert-info mb-0">Aucune semaine n'est disponible pour le semestre sélectionné.</div>
            {% endif %}
          </div>
          <div class="row g-2 align-items-center">
            <div class="col-sm-auto">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="requires_computers" id="requires_computers" {% if course.requires_computers %}checked{% endif %}>
                <label class="form-check-label" for="requires_computers">Ordinateurs requis</label>
              </div>
            </div>
            <div class="col">
              <label class="form-label mb-0" for="computers_required">Postes informatiques requis</label>
              <input
                type="number"
                class="form-control"
                name="computers_required"
                id="computers_required"
                min="0"
                value="{{ course.computers_required or 0 }}"
              >
              <div class="form-text">Indiquez 0 si le nombre exact de postes n'est pas contraignant.</div>
            </div>
          </div>
          <div>
            <label class="form-label">Enseignants</label>
            <div class="card teacher-allocation-card">
              <div class="card-header pb-0">
                <ul class="nav nav-tabs card-header-tabs" id="teacherAllocationTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link active"
                      id="teacher-selection-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#teacher-selection-pane"
                      type="button"
                      role="tab"
                      aria-controls="teacher-selection-pane"
                      aria-selected="true"
                    >Sélection</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="teacher-hours-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#teacher-hours-pane"
                      type="button"
                      role="tab"
                      aria-controls="teacher-hours-pane"
                      aria-selected="false"
                    >Heures à générer</button>
                  </li>
                </ul>
              </div>
              <div class="card-body tab-content">
                <div
                  class="tab-pane fade show active"
                  id="teacher-selection-pane"
                  role="tabpanel"
                  aria-labelledby="teacher-selection-tab"
                >
                  <div class="form-text mb-2">Sélectionnez les enseignants qui interviendront sur ce cours.</div>
                  <input
                    type="search"
                    class="form-control form-control-sm mb-3"
                    placeholder="Rechercher un enseignant..."
                    data-filter-target="#course-teachers-select-list"
                  >
                  <div id="course-teachers-select-list" class="vstack gap-2">
                    {% for teacher in teachers %}
                    {% set planned = teacher_hours_map.get(teacher.id, 0) %}
                    {% set scheduled = scheduled_hours_map.get(teacher.id, 0) %}
                    <div
                      class="border rounded p-2 teacher-select-row {% if planned > 0 %}is-selected{% endif %}"
                      data-filter-item
                      data-filter-text="{{ teacher.name|lower|e }} {{ teacher.email|lower|e if teacher.email }}"
                      data-teacher-id="{{ teacher.id }}"
                    >
                      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                        <div>
                          <div class="fw-semibold">{{ teacher.name }}</div>
                          {% if teacher.email %}
                          <div class="text-muted small">{{ teacher.email }}</div>
                          {% endif %}
                        </div>
                        <div class="form-check mb-0">
                          <input
                            class="form-check-input teacher-select-checkbox"
                            type="checkbox"
                            name="selected_teachers"
                            value="{{ teacher.id }}"
                            id="teacher-select-{{ teacher.id }}"
                            {% if planned > 0 %}checked{% endif %}
                          >
                          <label class="form-check-label" for="teacher-select-{{ teacher.id }}">Inclure</label>
                        </div>
                      </div>
                      <div class="text-muted small mt-2">
                        {% if scheduled %}
                        Heures déjà planifiées : {{ scheduled }} h
                        {% else %}
                        Aucune séance planifiée pour le moment.
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                <div
                  class="tab-pane fade"
                  id="teacher-hours-pane"
                  role="tabpanel"
                  aria-labelledby="teacher-hours-tab"
                >
                  <div class="form-text mb-2">Renseignez le volume horaire à planifier pour chaque enseignant sélectionné dans l'onglet précédent.</div>
                  <input
                    type="search"
                    class="form-control form-control-sm mb-3"
                    placeholder="Filtrer les enseignants sélectionnés..."
                    data-filter-target="#course-teachers-hours-list"
                  >
                  <div
                    id="teacher-hours-empty"
                    class="alert alert-info d-none py-2 px-3 mb-3 small"
                    role="alert"
                  >
                    Sélectionnez au moins un enseignant dans l'onglet « Sélection » pour définir ses heures.
                  </div>
                  <div id="course-teachers-hours-list" class="vstack gap-2">
                    {% for teacher in teachers %}
                    {% set planned = teacher_hours_map.get(teacher.id, 0) %}
                    {% set scheduled = scheduled_hours_map.get(teacher.id, 0) %}
                    <div
                      class="border rounded p-2 teacher-hours-row {% if planned > 0 %}is-selected{% else %}d-none{% endif %}"
                      data-filter-item
                      data-filter-text="{{ teacher.name|lower|e }} {{ teacher.email|lower|e if teacher.email }}"
                      data-teacher-id="{{ teacher.id }}"
                      data-require-selection="true"
                    >
                      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                        <div>
                          <div class="fw-semibold">{{ teacher.name }}</div>
                          {% if teacher.email %}
                          <div class="text-muted small">{{ teacher.email }}</div>
                          {% endif %}
                        </div>
                        <div class="d-flex align-items-center gap-2 teacher-hours-input">
                          <label class="form-label mb-0 small" for="teacher-hours-{{ teacher.id }}">Heures à générer</label>
                          <input
                            type="number"
                            class="form-control form-control-sm"
                            min="0"
                            step="1"
                            name="teacher_hours_{{ teacher.id }}"
                            id="teacher-hours-{{ teacher.id }}"
                            value="{{ planned }}"
                            data-default-hours="{{ course.session_length_hours }}"
                            {% if planned == 0 %}disabled{% endif %}
                          >
                        </div>
                      </div>
                      <div class="text-muted small mt-2">
                        {% if scheduled %}
                        Heures déjà planifiées : {{ scheduled }} h
                        {% else %}
                        Aucune séance planifiée pour le moment.
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div>
            <label class="form-label">Classes associées</label>
            <input
              type="search"
              class="form-control form-control-sm mb-2"
              placeholder="Rechercher une classe..."
              data-filter-target="#course-classes-list"
            >
            <div id="course-classes-list" class="vstack">
              {% for class_group in class_groups %}
              {% set link = class_links_map.get(class_group.id) %}
              <div class="border rounded p-2 mb-2" data-filter-item data-filter-text="{{ class_group.name|lower|e }}">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="classes" value="{{ class_group.id }}" id="class-{{ class_group.id }}" {% if link %}checked{% endif %}>
                  <label class="form-check-label" for="class-{{ class_group.id }}">
                    {{ class_group.name }} — {{ class_group.size }} étudiants
                  </label>
                </div>
                <div class="mt-2 ms-4 text-muted small">
                  {% if course.course_type == 'TP' %}
                  Ce cours sera planifié en deux sous-groupes qui utilisent les noms définis dans la page Configuration.
                  {% elif course.course_type == 'SAE' %}
                  Deux enseignants doivent être assignés simultanément pour cette classe.
                  {% elif course.course_type == 'CM' %}
                  Toutes les classes inscrites suivent le cours ensemble.
                  {% else %}
                  Ce cours est planifié pour la classe entière.
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div>
            <label class="form-label">Équipements requis</label>
            {% for equipment in equipments %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="equipments" value="{{ equipment.id }}" id="equip-{{ equipment.id }}" {% if equipment in course.equipments %}checked{% endif %}>
              <label class="form-check-label" for="equip-{{ equipment.id }}">{{ equipment.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div>
            <label class="form-label">Logiciels requis</label>
            {% for software in softwares %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="softwares" value="{{ software.id }}" id="soft-{{ software.id }}" {% if software in course.softwares %}checked{% endif %}>
              <label class="form-check-label" for="soft-{{ software.id }}">{{ software.name }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingQuickActions">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseQuickActions"
            aria-expanded="false"
            aria-controls="collapseQuickActions"
          >
            Actions rapides
          </button>
        </h2>
        <div
          id="collapseQuickActions"
          class="accordion-collapse collapse"
          aria-labelledby="headingQuickActions"
          data-bs-parent="#courseDetailsAccordion"
        >
          <div class="accordion-body">
            <div class="d-grid gap-2">
              <form
                method="post"
                class="vstack gap-2"
                data-chronos-progress
                data-chronos-progress-async="true"
                data-chronos-progress-hours="{{ course_remaining_hours }}"
                data-chronos-progress-label="{{ course.name }} — {{ course_remaining_hours }} heure(s) restante(s)."
              >
                <input type="hidden" name="form" value="auto-schedule">
                <div class="small text-muted">
                  <div class="text-uppercase fw-semibold mb-1">Semaines de planification</div>
                  {% if selected_course_week_labels %}
                  <ul class="mb-2 ps-3">
                    {% for label in selected_course_week_labels %}
                    <li>{{ label }}</li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <div class="mb-2">Aucune semaine spécifique : toute la période du semestre sera utilisée.</div>
                  {% endif %}
                  <div>Modifiez cette sélection dans l'onglet « Contraintes du cours ».</div>
                </div>
                <button class="btn btn-success" type="submit">Générer automatiquement</button>
              </form>
              <form method="post">
                <input type="hidden" name="form" value="clear-sessions">
                <button class="btn btn-outline-danger" type="submit" {% if not course.sessions %}disabled{% endif %}>
                  Supprimer toutes les séances planifiées
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-8">
    <div class="accordion" id="courseSummaryAccordion">
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingCourseCalendar">
          <button
            class="accordion-button bg-secondary text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseCourseCalendar"
            aria-expanded="true"
            aria-controls="collapseCourseCalendar"
          >
            Calendrier des séances
          </button>
        </h2>
        <div
          id="collapseCourseCalendar"
          class="accordion-collapse collapse show"
          aria-labelledby="headingCourseCalendar"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        <div id="course-calendar"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingGenerationLog">
          <button
            class="accordion-button collapsed bg-dark text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseGenerationLog"
            aria-expanded="false"
            aria-controls="collapseGenerationLog"
          >
            Journal de génération
          </button>
        </h2>
        <div
          id="collapseGenerationLog"
          class="accordion-collapse collapse"
          aria-labelledby="headingGenerationLog"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        {% if latest_generation_log %}
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ latest_generation_log.summary or 'Résultat enregistré' }}</div>
              <div class="text-muted small">
                {{ latest_generation_log.created_at.strftime('%d/%m/%Y %H:%M') }}
                {% if latest_generation_log.window_start and latest_generation_log.window_end %}
                — Période : {{ latest_generation_log.window_start }} → {{ latest_generation_log.window_end }}
                {% endif %}
              </div>
            </div>
            <span class="badge {{ status_badges.get(generation_display_status, 'bg-secondary') }}">{{ status_labels.get(generation_display_status, generation_display_status|title) }}</span>
          </div>
          {% set messages = latest_generation_log.parsed_messages() %}
          {% if messages %}
          <ul class="list-unstyled small mb-0 mt-3">
            {% for entry in messages %}
            <li class="d-flex flex-column gap-1 mb-2">
              <div class="d-flex align-items-start gap-2">
                <span class="badge {{ level_badges.get(entry.level, 'bg-secondary') }}">{{ latest_generation_log.level_label(entry.level) }}</span>
                <span>{{ entry.message }}</span>
              </div>
              {% if entry.suggestions %}
              <ul class="mb-0 small ps-5 text-muted">
                {% for suggestion in entry.suggestions %}
                <li>{{ suggestion }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
        {% else %}
        <p class="text-muted mb-0 small">Aucune génération enregistrée pour ce cours.</p>
        {% endif %}
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingTeacherSummary">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseTeacherSummary"
            aria-expanded="false"
            aria-controls="collapseTeacherSummary"
          >
            Synthèse des enseignants
          </button>
        </h2>
        <div
          id="collapseTeacherSummary"
          class="accordion-collapse collapse"
          aria-labelledby="headingTeacherSummary"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
            {% if teacher_summaries %}
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th scope="col">Enseignant</th>
                    <th scope="col" class="text-center">Heures à générer</th>
                    <th scope="col" class="text-center">Heures planifiées</th>
                    <th scope="col" class="text-center">Reste</th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in teacher_summaries %}
                  <tr>
                    <th scope="row">{{ entry.teacher.name }}</th>
                    <td class="text-center">{{ entry.planned }} h</td>
                    <td class="text-center">{{ entry.scheduled }} h</td>
                    <td class="text-center">{{ entry.remaining }} h</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted mb-0 small">Aucun enseignant n'est actuellement associé à ce cours.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="accordion-item shadow-sm">
        <h2 class="accordion-header" id="headingManualSession">
          <button
            class="accordion-button collapsed bg-info text-white"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseManualSession"
            aria-expanded="false"
            aria-controls="collapseManualSession"
          >
            Ajouter une séance manuelle
          </button>
        </h2>
        <div
          id="collapseManualSession"
          class="accordion-collapse collapse"
          aria-labelledby="headingManualSession"
          data-bs-parent="#courseSummaryAccordion"
        >
          <div class="accordion-body">
        {% if teachers and rooms and course.class_links %}
        <form method="post" class="row g-3">
          <input type="hidden" name="form" value="manual-session">
          <div class="col-md-4">
            <label class="form-label">Enseignant</label>
            <select class="form-select" name="teacher_id">
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Salle</label>
            <select class="form-select" name="room_id">
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Classe</label>
            <select class="form-select" name="class_group_choice">
              {% if course.is_cm %}
                {% set class_names = course.class_links | map(attribute='class_group.name') | join(', ') %}
                <option value="ALL">
                  Toutes les classes
                  {% if class_names %}— {{ class_names }}{% endif %}
                </option>
              {% else %}
                {% for link in course.class_links %}
                  {% for subgroup_label in link.group_labels() %}
                  {% set value = link.class_group.id ~ ':' ~ (subgroup_label if subgroup_label else '') %}
                  {% set subgroup_display = link.subgroup_name_for(subgroup_label) %}
                  <option value="{{ value }}">
                    {{ link.class_group.name }} — {% if subgroup_label %}{{ subgroup_display }}{% else %}classe entière{% endif %}
                  </option>
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Heure de début</label>
            <select class="form-select" name="start_time">
              {% for start_time in start_times %}
              <option value="{{ start_time.strftime('%H:%M') }}">
                {{ start_time.strftime('%H:%M') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Durée (heures)</label>
            <input type="number" class="form-control" name="duration" value="{{ course.session_length_hours }}" min="1">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-info text-white">Ajouter</button>
          </div>
        </form>
        {% else %}
        <p class="text-muted mb-0">Ajoutez au moins un enseignant, une salle et associez une classe pour planifier manuellement une séance.</p>
        {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  function chronosBindFilterInputs() {
    document.querySelectorAll('[data-filter-target]').forEach(function(input) {
      const targetSelector = input.getAttribute('data-filter-target');
      if (!targetSelector) {
        return;
      }
      const target = document.querySelector(targetSelector);
      if (!target) {
        return;
      }
      const updateVisibility = function() {
        const query = (input.value || '').trim().toLowerCase();
        const hasQuery = query.length > 0;
        const items = target.querySelectorAll('[data-filter-item]');
        items.forEach(function(item) {
          const filterText = (item.getAttribute('data-filter-text') || item.textContent || '').toLowerCase();
          const isSelected = item.classList.contains('is-selected');
          const requiresSelection = item.getAttribute('data-require-selection') === 'true';
          if (requiresSelection && !isSelected) {
            item.classList.add('d-none');
            return;
          }
          const matchesQuery = filterText.indexOf(query) !== -1;
          if (!hasQuery || matchesQuery || isSelected) {
            item.classList.remove('d-none');
          } else {
            item.classList.add('d-none');
          }
        });
      };
      input.addEventListener('input', updateVisibility);
      target.addEventListener('change', updateVisibility, true);
      updateVisibility();
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    chronosBindFilterInputs();
    function chronosSyncTeacherSelections() {
      const selectionRows = document.querySelectorAll('.teacher-select-row');
      const selectionCheckboxes = document.querySelectorAll('.teacher-select-checkbox');
      const hoursRows = document.querySelectorAll('.teacher-hours-row');
      const emptyNotice = document.getElementById('teacher-hours-empty');
      const hourFilters = document.querySelectorAll('[data-filter-target="#course-teachers-hours-list"]');
      let selectedCount = 0;

      const hoursRowByTeacherId = {};
      hoursRows.forEach(function(row) {
        const teacherId = row.getAttribute('data-teacher-id');
        if (teacherId) {
          hoursRowByTeacherId[teacherId] = row;
        }
      });

      const selectionRowByTeacherId = {};
      selectionRows.forEach(function(row) {
        const teacherId = row.getAttribute('data-teacher-id');
        if (teacherId) {
          selectionRowByTeacherId[teacherId] = row;
        }
      });

      selectionCheckboxes.forEach(function(checkbox) {
        const teacherId = checkbox.value;
        const hoursRow = hoursRowByTeacherId[teacherId];
        const selectionRow = selectionRowByTeacherId[teacherId];
        const hoursInput = hoursRow ? hoursRow.querySelector('input[type="number"]') : null;
        const isChecked = checkbox.checked;

        if (selectionRow) {
          selectionRow.classList.toggle('is-selected', isChecked);
        }

        if (hoursRow) {
          hoursRow.classList.toggle('is-selected', isChecked);
          if (hoursRow.getAttribute('data-require-selection') === 'true') {
            hoursRow.classList.toggle('d-none', !isChecked);
          }
        }

        if (hoursInput) {
          if (isChecked) {
            hoursInput.removeAttribute('disabled');
            const currentValue = parseInt(hoursInput.value, 10);
            if (isNaN(currentValue) || currentValue <= 0) {
              const defaultHours = parseInt(hoursInput.getAttribute('data-default-hours'), 10);
              if (!isNaN(defaultHours) && defaultHours > 0) {
                hoursInput.value = defaultHours;
              }
            }
            selectedCount += 1;
          } else {
            hoursInput.setAttribute('disabled', 'disabled');
          }
        }
      });

      if (emptyNotice) {
        emptyNotice.classList.toggle('d-none', selectedCount > 0);
      }

      hourFilters.forEach(function(filterInput) {
        filterInput.dispatchEvent(new Event('input'));
      });
    }

    chronosSyncTeacherSelections();
    document.querySelectorAll('.teacher-select-checkbox').forEach(function(checkbox) {
      checkbox.addEventListener('change', chronosSyncTeacherSelections);
    });
    document.querySelectorAll('#course-teachers-hours-list input[type="number"]').forEach(function(input) {
      input.addEventListener('input', function() {
        const row = input.closest('.teacher-hours-row');
        if (!row) {
          return;
        }
        const value = parseInt(input.value, 10);
        const hasHours = !isNaN(value) && value > 0;
        row.classList.toggle('has-hours', hasHours);
        if (!hasHours) {
          const teacherId = row.getAttribute('data-teacher-id');
          const checkbox = document.querySelector('.teacher-select-checkbox[value="' + teacherId + '"]');
          if (checkbox && checkbox.checked) {
            checkbox.checked = false;
            chronosSyncTeacherSelections();
          }
        }
      });
      const initialValue = parseInt(input.value, 10);
      if (!isNaN(initialValue) && initialValue > 0) {
        const row = input.closest('.teacher-hours-row');
        if (row) {
          row.classList.add('has-hours');
        }
      }
    });
    const calendarEl = document.getElementById('course-calendar');
    const events = {{ events_json|safe }};
    const calendar = window.createChronosCalendar(calendarEl, events);
    calendar.render();
  });
</script>
{% endblock %}
