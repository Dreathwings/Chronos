{% extends 'base.html' %}
{% block title %}Cours — Chronos{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/courses.css') }}">
{% endblock %}

{% block content %}
<div class="accordion chronos-accordion" id="coursesAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="coursesCreateHeading">
      <button class="accordion-button collapsed bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#coursesCreate" aria-expanded="false" aria-controls="coursesCreate">
        Nouveau cours
      </button>
    </h2>
    <div id="coursesCreate" class="accordion-collapse collapse" aria-labelledby="coursesCreateHeading" data-bs-parent="#coursesAccordion">
      <div class="accordion-body">
        <form method="post" class="vstack gap-3">
          <input type="hidden" name="form" value="create">
          <div>
            <label class="form-label">Nom</label>
            {% if course_names %}
            <select class="form-select" name="course_name_id" required>
              <option value="" disabled selected>Choisissez un nom configuré…</option>
              {% for course_name in course_names %}
              <option value="{{ course_name.id }}">{{ course_name.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Le nom final suivra le format TYPE - NOM - SEMESTRE.</div>
            <div class="form-text">Modifiez la liste dans la page Configuration.</div>
            {% else %}
            <div class="alert alert-warning mb-0" role="alert">
              Aucun nom n'est disponible. Ajoutez-en depuis la configuration pour créer un cours.
            </div>
            {% endif %}
          </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Type de cours</label>
              <select class="form-select" name="course_type">
                <option value="CM">Cours magistral</option>
                <option value="TD">Travaux dirigés</option>
                <option value="TP">Travaux pratiques</option>
                <option value="SAE">Situation d'apprentissage et d'évaluation</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Semestre</label>
              <select class="form-select" name="semester">
                {% for semester in semester_choices %}
                <option value="{{ semester }}" {% if semester == default_semester %}selected{% endif %}>{{ semester }}</option>
                {% endfor %}
              </select>
              <div class="form-text">La période est déterminée automatiquement selon le semestre.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Durée séance (h)</label>
              <input type="number" class="form-control" name="session_length_hours" value="2" min="1">
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Nombre de séances</label>
              <input type="number" class="form-control" name="sessions_required" value="1" min="1">
            </div>
            <div class="col">
              <label class="form-label">Priorité</label>
              <input type="number" class="form-control" name="priority" value="1" min="1">
            </div>
          </div>
          <div class="row g-2 align-items-center">
            <div class="col-sm-auto">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" name="requires_computers" id="requires_computers">
                <label class="form-check-label" for="requires_computers">Ordinateurs requis</label>
              </div>
            </div>
            <div class="col">
              <label class="form-label mb-0" for="new_computers_required">Postes informatiques requis</label>
              <input
                type="number"
                class="form-control"
                name="computers_required"
                id="new_computers_required"
                min="0"
                value="0"
              >
              <div class="form-text">Laissez 0 si seul l'accès à des ordinateurs est requis.</div>
            </div>
          </div>
          <div>
            <label class="form-label">Classes associées</label>
            {% if class_groups %}
            <div class="vstack gap-2">
              {% for class_group in class_groups %}
              <div class="border rounded p-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="classes" value="{{ class_group.id }}" id="new-class-{{ class_group.id }}">
                  <label class="form-check-label" for="new-class-{{ class_group.id }}">
                    {{ class_group.name }} — {{ class_group.size }} étudiants
                  </label>
                </div>
                <div class="mt-2 ms-4 text-muted small">
                  Les travaux pratiques seront automatiquement répartis en deux sous-groupes utilisant les noms configurés.
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="form-text mb-0">Aucune classe disponible pour le moment.</p>
            {% endif %}
          </div>
          <div>
            <label class="form-label">Équipements requis</label>
            {% for equipment in equipments %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="equipments" value="{{ equipment.id }}" id="new-equip-{{ equipment.id }}">
              <label class="form-check-label" for="new-equip-{{ equipment.id }}">{{ equipment.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div>
            <label class="form-label">Logiciels requis</label>
            {% for software in softwares %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="softwares" value="{{ software.id }}" id="new-soft-{{ software.id }}">
              <label class="form-check-label" for="new-soft-{{ software.id }}">{{ software.name }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary" {% if not course_names %}disabled{% endif %}>Créer</button>
        </form>
      </div>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header" id="coursesListHeading">
      <button class="accordion-button bg-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#coursesList" aria-expanded="true" aria-controls="coursesList">
        Cours
      </button>
    </h2>
    <div id="coursesList" class="accordion-collapse collapse show" aria-labelledby="coursesListHeading" data-bs-parent="#coursesAccordion">
      <div class="accordion-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Semestre</th>
                <th>Période</th>
                <th>Heures planifiées</th>
                <th>Priorité</th>
                <th>Classes</th>
              </tr>
            </thead>
            <tbody>
              {% for course in courses %}
              <tr>
                <td><a href="{{ url_for('main.course_detail', course_id=course.id) }}">{{ course.name }}</a></td>
                <td>{{ course_type_labels.get(course.course_type, course.course_type) }}</td>
                <td>{{ course.semester }}</td>
                <td>
                  {% if course.semester_start and course.semester_end %}
                  {{ course.semester_start }} → {{ course.semester_end }}
                  {% else %}
                  —
                  {% endif %}
                </td>
                {% set group_total = course.class_links | map(attribute='group_count') | sum %}
                {% set required_hours = course.total_required_hours %}
                <td>{{ course.scheduled_hours }}h/{{ required_hours }}h</td>
                <td>{{ course.priority }}</td>
                <td style="width: 30%;">
                  {% if course.class_links %}
                  {% if course.course_type == 'CM' %}
                  <div class="text-muted small mb-2">Cours magistral — classes regroupées</div>
                  {% endif %}
                  <div class="vstack gap-2">
                    {% for link in course.class_links %}
                    <div>
                      <span class="fw-semibold">{{ link.class_group.name }}</span>
                      {% if course.course_type == 'TP' %}
                      <span class="badge bg-info text-dark ms-1">Demi-groupes</span>
                      {% endif %}
                      <ul class="list-unstyled ms-3 mb-0 small text-muted">
                        {% if course.course_type == 'SAE' %}
                        <li>
                          Enseignant 1
                          {% if link.teacher_a %}
                          — {{ link.teacher_a.name }}
                          {% else %}
                          — Aucun enseignant
                          {% endif %}
                        </li>
                        <li>
                          Enseignant 2
                          {% if link.teacher_b %}
                          — {{ link.teacher_b.name }}
                          {% else %}
                          — Aucun enseignant
                          {% endif %}
                        </li>
                        {% else %}
                        {% for label, teacher in link.teacher_labels() %}
                        <li>
                          {% if label %}
                            {{ label }}
                          {% else %}
                            Classe entière
                          {% endif %}
                          {% if teacher %}
                          — {{ teacher.name }}
                          {% else %}
                          — Aucun enseignant
                          {% endif %}
                        </li>
                        {% endfor %}
                        {% endif %}
                      </ul>
                    </div>
                    {% endfor %}
                  </div>
                  {% else %}
                  —
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
