{% extends 'base.html' %}
{% block title %}Cours — Chronos{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">Nouveau cours</div>
      <div class="card-body">
        <form method="post" class="vstack gap-3">
          <input type="hidden" name="form" value="create">
          <div>
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div>
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Étudiants attendus</label>
              <input type="number" class="form-control" name="expected_students" value="10" min="1">
            </div>
            <div class="col">
              <label class="form-label">Durée séance (h)</label>
              <input type="number" class="form-control" name="session_length_hours" value="2" min="1">
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Nombre de séances</label>
              <input type="number" class="form-control" name="sessions_required" value="1" min="1">
            </div>
            <div class="col">
              <label class="form-label">Priorité</label>
              <input type="number" class="form-control" name="priority" value="1" min="1">
            </div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Début</label>
              <input type="date" class="form-control" name="start_date">
            </div>
            <div class="col">
              <label class="form-label">Fin</label>
              <input type="date" class="form-control" name="end_date">
            </div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="requires_computers" id="requires_computers">
            <label class="form-check-label" for="requires_computers">Ordinateurs requis</label>
          </div>
          <div>
            <label class="form-label">Classes associées</label>
            {% if class_groups %}
            <div class="vstack gap-2">
              {% for class_group in class_groups %}
              <div class="border rounded p-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="classes" value="{{ class_group.id }}" id="new-class-{{ class_group.id }}">
                  <label class="form-check-label" for="new-class-{{ class_group.id }}">
                    {{ class_group.name }} — {{ class_group.size }} étudiants
                  </label>
                </div>
                <div class="mt-2 ms-4">
                  <label class="form-label text-muted mb-1 small">Répartition</label>
                  <select class="form-select form-select-sm w-auto" name="class_group_groups_{{ class_group.id }}">
                    <option value="1" selected>Classe entière</option>
                    <option value="2">Demi-groupes (x2)</option>
                  </select>
                  <div class="form-text">Le mode demi-groupe planifie deux séances avec la moitié des étudiants.</div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="form-text mb-0">Aucune classe disponible pour le moment.</p>
            {% endif %}
          </div>
          <div>
            <label class="form-label">Équipements requis</label>
            {% for equipment in equipments %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="equipments" value="{{ equipment.id }}" id="new-equip-{{ equipment.id }}">
              <label class="form-check-label" for="new-equip-{{ equipment.id }}">{{ equipment.name }}</label>
            </div>
            {% endfor %}
          </div>
          <div>
            <label class="form-label">Logiciels requis</label>
            {% for software in softwares %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="softwares" value="{{ software.id }}" id="new-soft-{{ software.id }}">
              <label class="form-check-label" for="new-soft-{{ software.id }}">{{ software.name }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary">Créer</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-secondary text-white">Cours</div>
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Période</th>
              <th>Séances</th>
              <th>Priorité</th>
              <th>Classes</th>
            </tr>
          </thead>
          <tbody>
            {% for course in courses %}
            <tr>
              <td><a href="{{ url_for('main.course_detail', course_id=course.id) }}">{{ course.name }}</a></td>
              <td>{{ course.start_date or '—' }} → {{ course.end_date or '—' }}</td>
              {% set group_total = course.class_links | map(attribute='group_count') | sum %}
              {% set required_total = course.sessions_required * (group_total if group_total else 1) %}
              <td>{{ course.sessions|length }}/{{ required_total }}</td>
              <td>{{ course.priority }}</td>
              <td>
                {% if course.class_links %}
                <div class="vstack gap-1">
                  {% for link in course.class_links %}
                  <span>{{ link.class_group.name }}{% if link.group_count == 2 %} <span class="badge bg-info text-dark">Demi-groupes</span>{% endif %}</span>
                  {% endfor %}
                </div>
                {% else %}
                —
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
