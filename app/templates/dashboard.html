{% extends 'base.html' %}
{% block title %}Tableau de bord — Chronos{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-view">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <label for="dashboard-global-search" class="form-label text-uppercase small fw-semibold mb-2">Recherche globale</label>
      <input type="search" class="form-control" id="dashboard-global-search" placeholder="Rechercher un cours, une salle, une classe..." autocomplete="off">
      <div class="list-group mt-3 d-none" id="global-search-results"></div>
    </div>
  </div>
  <div class="card shadow-sm dashboard-calendar-card">
    <div class="card-header bg-secondary text-white">Calendrier global</div>
    <div class="card-body">
      <div id="global-calendar"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('global-calendar');
    const events = {{ events_json|safe }};
    const calendar = window.createChronosCalendar(calendarEl, events);
    calendar.render();

    const globalSearchData = {{ global_search_index_json|safe }};
    const globalSearchInput = document.getElementById('dashboard-global-search');
    const globalSearchResults = document.getElementById('global-search-results');
    if (globalSearchInput && globalSearchResults && Array.isArray(globalSearchData)) {
      const renderGlobalResults = function(query) {
        globalSearchResults.innerHTML = '';
        if (!query) {
          globalSearchResults.classList.add('d-none');
          return;
        }
        const lowered = query.toLowerCase();
        const matches = globalSearchData.filter(function(item) {
          return (item.tokens || '').indexOf(lowered) !== -1;
        }).slice(0, 8);
        if (!matches.length) {
          const emptyItem = document.createElement('div');
          emptyItem.className = 'list-group-item small text-muted';
          emptyItem.textContent = 'Aucun résultat';
          globalSearchResults.appendChild(emptyItem);
          globalSearchResults.classList.remove('d-none');
          return;
        }
        matches.forEach(function(item) {
          const link = document.createElement('a');
          link.className = 'list-group-item list-group-item-action';
          link.href = item.url;
          link.innerHTML = '<div class="fw-semibold">' + item.label + '</div>' +
            '<div class="small text-muted">' + item.type_label + '</div>';
          globalSearchResults.appendChild(link);
        });
        globalSearchResults.classList.remove('d-none');
      };

      globalSearchInput.addEventListener('input', function() {
        renderGlobalResults(this.value.trim());
      });

      globalSearchInput.addEventListener('focus', function() {
        if (this.value) {
          renderGlobalResults(this.value.trim());
        }
      });

      globalSearchInput.addEventListener('blur', function() {
        setTimeout(function() {
          globalSearchResults.classList.add('d-none');
        }, 200);
      });
    }

  });
</script>
{% endblock %}
