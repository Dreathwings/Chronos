{% extends 'base.html' %}
{% block title %}Génération — Chronos{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/generation.css') }}">
{% endblock %}

{% block content %}
<div class="generation-view">
  <div class="card shadow-sm generation-header">
    <div class="card-body">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
          <h1 class="h4 mb-1">Génération automatique</h1>
          <p class="text-muted mb-0">Lancez la planification globale et identifiez rapidement les cours à corriger.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <form method="post">
            <input type="hidden" name="form" value="generate">
            <button type="submit" class="btn btn-primary">Générer les cours</button>
          </form>
          <form method="post" onsubmit="return confirm('Supprimer toutes les séances générées ?');">
            <input type="hidden" name="form" value="clear">
            <button type="submit" class="btn btn-outline-danger">Supprimer toutes les séances</button>
          </form>
        </div>
      </div>
      <div class="row row-cols-2 row-cols-md-3 row-cols-xl-6 g-3 mt-3">
        <div class="col">
          <div class="generation-stat">
            <div class="generation-stat-value">{{ total_courses }}</div>
            <div class="generation-stat-label">Cours</div>
          </div>
        </div>
        <div class="col">
          <div class="generation-stat">
            <div class="generation-stat-value">{{ scheduled_courses }}</div>
            <div class="generation-stat-label">Cours planifiés</div>
          </div>
        </div>
        <div class="col">
          <div class="generation-stat">
            <div class="generation-stat-value text-danger">{{ error_courses }}</div>
            <div class="generation-stat-label">Cours en erreur</div>
          </div>
        </div>
        <div class="col">
          <div class="generation-stat">
            <div class="generation-stat-value text-warning">{{ warning_courses }}</div>
            <div class="generation-stat-label">Cours en alerte</div>
          </div>
        </div>
        <div class="col">
          <div class="generation-stat">
            <div class="generation-stat-value">{{ total_scheduled_hours }}</div>
            <div class="generation-stat-label">Heures planifiées</div>
          </div>
        </div>
        <div class="col">
          <div class="generation-stat">
            <div class="generation-stat-value">{{ total_remaining_hours }}</div>
            <div class="generation-stat-label">Heures restantes</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <div class="table-responsive generation-table">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Cours</th>
              <th class="text-center">Séances</th>
              <th>Heures planifiées</th>
              <th>Statut</th>
              <th>Dernière génération</th>
              <th>Erreurs détectées</th>
              <th>Pistes de résolution</th>
            </tr>
          </thead>
          <tbody>
            {% for row in course_rows %}
            <tr class="{% if row.status == 'error' %}table-danger{% elif row.status == 'warning' %}table-warning{% endif %}">
              <td>
                <div class="fw-semibold">
                  <a href="{{ url_for('main.course_detail', course_id=row.course.id) }}">{{ row.course.name }}</a>
                </div>
                <div class="text-muted small">
                  {{ course_type_labels.get(row.course.course_type, row.course.course_type) }}
                  {% if row.class_labels %} • {{ row.class_labels }}{% endif %}
                </div>
              </td>
              <td class="text-center">
                <div class="fw-semibold">{{ row.sessions_count }}</div>
                <div class="text-muted small">{{ row.remaining_hours }} h restantes</div>
              </td>
              <td>
                <div class="fw-semibold">{{ row.scheduled_hours }} / {{ row.required_hours }} h</div>
                <div class="progress generation-progress mt-2">
                  {% set progress = 0 %}
                  {% if row.required_hours > 0 %}
                    {% set progress = (row.scheduled_hours / row.required_hours * 100) | round(0, 'floor') %}
                  {% endif %}
                  <div class="progress-bar" role="progressbar" style="width: {{ progress }}%" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </td>
              <td>
                <span class="badge {{ status_badges.get(row.status, 'bg-secondary') }}">
                  {{ status_labels.get(row.status, row.status|title) }}
                </span>
              </td>
              <td>
                {% if row.latest_log %}
                <div class="fw-semibold">{{ row.latest_log.summary or 'Résultat enregistré' }}</div>
                <div class="text-muted small">
                  {{ row.latest_log.created_at.strftime('%d/%m/%Y %H:%M') }}
                </div>
                {% else %}
                <span class="text-muted small">Jamais généré</span>
                {% endif %}
              </td>
              <td>
                {% if row.errors %}
                <ul class="mb-0 ps-3 small">
                  {% for error in row.errors %}
                  <li>{{ error }}</li>
                  {% endfor %}
                </ul>
                {% else %}
                <span class="text-muted small">Aucune erreur enregistrée.</span>
                {% endif %}
              </td>
              <td>
                {% if row.suggestions %}
                <ul class="mb-0 ps-3 small text-muted">
                  {% for suggestion in row.suggestions %}
                  <li>{{ suggestion }}</li>
                  {% endfor %}
                </ul>
                {% else %}
                <span class="text-muted small">Rien à signaler.</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
